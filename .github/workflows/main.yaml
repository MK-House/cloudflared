name: "Deploy Cloudflared"
run-name: "${{ github.event_name }} by ${{ github.actor }} #${{ github.run_number }}.${{ github.run_attempt }}"

on:
  push:
    branches:
      - "main"

env:
  ANSIBLE_PROJECT: "${{ vars.ANSIBLE_PROJECT }}"
  CLOUDFLARED_PROJECT: "${{ vars.CLOUDFLARED_PROJECT }}"

jobs:
  deploy-cloudflared:
    runs-on:
      - "self-hosted"
    steps:
      - name: "Checkout repository"
        uses: "actions/checkout@v2"
      - name: "Public cloudflared Docker Compose"
        run: |
          sudo rm -rf ${CLOUDFLARED_PROJECT}/*
          sudo mkdir -p ${CLOUDFLARED_PROJECT}
          sudo chmod 0755 ${CLOUDFLARED_PROJECT}
          sudo cp -r . ${CLOUDFLARED_PROJECT}/
          sudo rm -rf ${CLOUDFLARED_PROJECT}/.github
      - name: "Run Ansible Playbook"
        run: ansible-playbook ./ansible/playbooks/deploy-cloudflared.yml -i ${ANSIBLE_PROJECT}/inventory/hosts.ini
